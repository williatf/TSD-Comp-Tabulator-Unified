<UserControl x:Class="Tsd.Tabulator.Wpf.Views.Reports.DuetsAwardsReportTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">
    <UserControl.Resources>
        <CollectionViewSource x:Key="GroupedByBucket" Source="{Binding Report.Groups}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Bucket"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBar Grid.Row="0" ToolBarTray.IsLocked="True">
            <Button x:Name="ExportCsv"
                    Content="Export CSV"
                    ToolTip="Export report to CSV file"/>
        </ToolBar>

        <!-- Error Message -->
        <Border Grid.Row="1"
                Background="#FFEBEE"
                BorderBrush="#F44336"
                BorderThickness="1"
                Padding="10"
                Margin="5"
                Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="⚠ "
                          FontSize="16"
                          Foreground="#D32F2F"
                          Margin="0,0,5,0"/>
                <TextBlock Text="{Binding ErrorMessage}"
                          TextWrapping="Wrap"
                          Foreground="#D32F2F"/>
            </StackPanel>
        </Border>

        <!-- Warning Message -->
        <Border Grid.Row="2"
                Background="#FFF9C4"
                BorderBrush="#FBC02D"
                BorderThickness="1"
                Padding="10"
                Margin="5"
                Visibility="{Binding HasWarning, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="⚠ "
                          FontSize="16"
                          Foreground="#F57C00"
                          Margin="0,0,5,0"/>
                <TextBlock Text="{Binding WarningMessage}"
                          TextWrapping="Wrap"
                          Foreground="#F57C00"/>
            </StackPanel>
        </Border>

        <!-- Report Content -->
        <ScrollViewer Grid.Row="3"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Disabled">
            <StackPanel>
                <!-- Instructions Header -->
                <Border Background="#E3F2FD"
                       BorderBrush="#2196F3"
                       BorderThickness="2"
                       Padding="20"
                       Margin="10,10,10,20"
                       MaxWidth="1400"
                       HorizontalAlignment="Left">
                    <StackPanel>
                        <TextBlock Text="Duet Trophies"
                                  FontSize="24"
                                  FontWeight="Bold"
                                  Foreground="#1976D2"
                                  Margin="0,0,0,10"/>
                        <TextBlock Text="Highest Scores at top!!"
                                  FontSize="18"
                                  FontWeight="SemiBold"
                                  Foreground="#1976D2"
                                  Margin="0,0,0,15"/>
                        <TextBlock TextWrapping="Wrap"
                                  FontSize="14"
                                  Foreground="#424242"
                                  LineHeight="22">
                            <Run Text="Only the top 5 performers should receive trophies. In a tie situation, all tied competitors would receive the same award.  For example, if there is a tie between two dancers for 1st runner up, both dancers would receive 1st runner up trophies, you would skip 2nd runner up, and the next dancer would receive the 3rd runner up trophy."/>
                            <LineBreak/>
                            <LineBreak/>
                            <Run Text="The top 12 scores have been recorded below for your reference." FontWeight="SemiBold"/>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Outer loop: Buckets (Studio, School, etc.) -->
                <ItemsControl ItemsSource="{Binding GroupedByBucket}"
                             Margin="10"
                             MaxWidth="1400"
                             HorizontalAlignment="Left">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="0,0,0,30">
                                <!-- Bucket Header -->
                                <Border Background="#1976D2"
                                       Padding="15,8"
                                       Margin="0,0,0,15">
                                    <TextBlock Text="{Binding Key}"
                                              FontSize="20"
                                              FontWeight="Bold"
                                              Foreground="White"/>
                                </Border>
                                
                                <!-- Inner loop: Classes within this Bucket -->
                                <ItemsControl ItemsSource="{Binding}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="20,0,0,20">
                                                <!-- Class Header -->
                                                <Border Background="#2196F3"
                                                       Padding="10,5"
                                                       Margin="0,0,0,5">
                                                    <TextBlock Text="{Binding Class}"
                                                              FontSize="16"
                                                              FontWeight="SemiBold"
                                                              Foreground="White"/>
                                                </Border>

                                                <!-- Entries Table -->
                                                <ListView ItemsSource="{Binding Entries}"
                                                          SelectionMode="Single">
                                                    <ListView.ItemContainerStyle>
                                                        <Style TargetType="ListViewItem">
                                                            <Style.Triggers>
                                                                <Trigger Property="ItemsControl.AlternationIndex" Value="1">
                                                                    <Setter Property="Background" Value="#F5F5F5"/>
                                                                </Trigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ListView.ItemContainerStyle>
                                                    <ListView.View>
                                                        <GridView>
                                                            <GridViewColumn Header="Place" 
                                                                           DisplayMemberBinding="{Binding Place}" 
                                                                           Width="60"/>
                                                            <GridViewColumn Header="Score" 
                                                                           DisplayMemberBinding="{Binding FinalScore, StringFormat=F2}" 
                                                                           Width="80"/>
                                                            <GridViewColumn Header="Program #" 
                                                                           DisplayMemberBinding="{Binding ProgramNumber}" 
                                                                           Width="90"/>
                                                            <GridViewColumn Header="Participants" 
                                                                           DisplayMemberBinding="{Binding Participants}" 
                                                                           Width="200"/>
                                                            <GridViewColumn Header="Studio" 
                                                                           DisplayMemberBinding="{Binding StudioName}" 
                                                                           Width="200"/>
                                                            <GridViewColumn Header="Routine" 
                                                                           DisplayMemberBinding="{Binding RoutineTitle}" 
                                                                           Width="Auto"/>
                                                        </GridView>
                                                    </ListView.View>
                                                </ListView>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!-- Loading Indicator -->
        <Border Grid.Row="3"
                Background="#80FFFFFF"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                       VerticalAlignment="Center">
                <TextBlock Text="Loading Duet Awards..."
                          FontSize="16"
                          Margin="0,0,0,10"/>
                <ProgressBar IsIndeterminate="True"
                            Width="200"
                            Height="20"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
