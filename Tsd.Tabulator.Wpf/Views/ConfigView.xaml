<UserControl x:Class="Tsd.Tabulator.Wpf.Views.ConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:cal="http://www.caliburnproject.org"
             mc:Ignorable="d">

    <Grid Margin="12">
        <TabControl>
            <!-- General tab: preserve existing config UI -->
            <TabItem Header="General">
                <Grid Margin="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel>
                        <TextBlock Text="Event Configuration" FontSize="22" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding CurrentEventFolder}" Opacity="0.65" Margin="0,2,0,0"/>
                    </StackPanel>

                    <ScrollViewer Grid.Row="1" Margin="0,12,0,0" VerticalScrollBarVisibility="Auto">
                        <StackPanel MaxWidth="600" HorizontalAlignment="Left">

                            <!-- Competition Type Section -->
                            <Border Padding="16" BorderBrush="#DDD" BorderThickness="1" Background="White">
                                <StackPanel>
                                    <TextBlock Text="Competition Type" 
                                               FontSize="16" 
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,8"/>

                                    <TextBlock Text="Select the competition type to determine which score sheets are available."
                                               TextWrapping="Wrap"
                                               Opacity="0.7"
                                               Margin="0,0,0,12"/>

                                    <ComboBox ItemsSource="{Binding AvailableCompetitionTypes}"
                                              SelectedItem="{Binding SelectedCompetitionType}"
                                              DisplayMemberPath="DisplayName"
                                              MinWidth="200"
                                              HorizontalAlignment="Left"/>

                                </StackPanel>
                            </Border>

                            <!-- Event Info Section -->
                            <Border Padding="16" 
                                    BorderBrush="#DDD" 
                                    BorderThickness="1" 
                                    Background="White"
                                    Margin="0,12,0,0">
                                <StackPanel>
                                    <TextBlock Text="Event Information" 
                                               FontSize="16" 
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,8"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" 
                                                   Text="Event Loaded:" 
                                                   Opacity="0.7"
                                                   Margin="0,0,0,4"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding HasEventLoaded}"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,4"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                                   Text="Database Path:"
                                                   Opacity="0.7"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1"
                                                   Text="{Binding CurrentDbPath}"
                                                   TextWrapping="Wrap"/>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Testing Tools Section -->
                            <Border Padding="16" 
                                    BorderBrush="#FFA500" 
                                    BorderThickness="2" 
                                    Background="#FFF9F0"
                                    Margin="0,12,0,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                        <TextBlock Text="⚠️" FontSize="18" Margin="0,0,8,0"/>
                                        <TextBlock Text="Testing Tools" 
                                                   FontSize="16" 
                                                   FontWeight="SemiBold"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <TextBlock Text="Use these tools for testing reports and clearing test data. These operations affect ALL routines."
                                               TextWrapping="Wrap"
                                               Opacity="0.7"
                                               Margin="0,0,0,12"/>

                                    <!-- Generate Random Scores Button -->
                                    <Button x:Name="GenerateRandomScores"
                                            Content="Generate Random Test Scores"
                                            Padding="12,8"
                                            Background="#4CAF50"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            Margin="0,0,0,8">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                                    CornerRadius="3"
                                                                    Padding="{TemplateBinding Padding}">
                                                                <ContentPresenter HorizontalAlignment="Center" 
                                                                                  VerticalAlignment="Center"/>
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Background" Value="#45A049"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <TextBlock Text="Creates random scores (70-100%) for all routines on the Standard sheet. Useful for testing reports."
                                               TextWrapping="Wrap"
                                               FontSize="11"
                                               Opacity="0.6"
                                               Margin="0,0,0,12"/>

                                    <!-- Clear All Scores Button -->
                                    <Button x:Name="ClearAllScores"
                                            Content="Clear All Scores"
                                            Padding="12,8"
                                            Background="#F44336"
                                            Foreground="White"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            Margin="0,0,0,8">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                                    CornerRadius="3"
                                                                    Padding="{TemplateBinding Padding}">
                                                                <ContentPresenter HorizontalAlignment="Center" 
                                                                                  VerticalAlignment="Center"/>
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter Property="Background" Value="#DA190B"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <TextBlock Text="⚠️ Permanently deletes ALL scores for ALL routines. Cannot be undone!"
                                               TextWrapping="Wrap"
                                               FontSize="11"
                                               FontWeight="Bold"
                                               Foreground="#D32F2F"
                                               Margin="0,0,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Future sections placeholder -->
                            <Border Padding="16" 
                                    BorderBrush="#DDD" 
                                    BorderThickness="1" 
                                    Background="#F9F9F9"
                                    Margin="0,12,0,0">
                                <StackPanel>
                                    <TextBlock Text="Additional Settings" 
                                               FontSize="16" 
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,8"/>
                                    <TextBlock Text="Future configuration options (awards, report formats, etc.) will appear here."
                                               TextWrapping="Wrap"
                                               Opacity="0.6"
                                               FontStyle="Italic"/>
                                </StackPanel>
                            </Border>

                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <!-- Class Order tab: new enhancement UI -->
            <TabItem Header="Class Order" Height="20" VerticalAlignment="Top">
                <Grid Margin="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="1.2*" />
                    </Grid.ColumnDefinitions>

                    <GroupBox Header="Class Definitions" Grid.Column="0" Margin="4">
                        <DockPanel>
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="4">
                                <Button Content="Add" cal:Message.Attach="AddDefinition" Margin="0,0,4,0" />
                                <Button Content="Save All" cal:Message.Attach="SaveAllDefinitions" Margin="0,0,4,0" />
                                <Button Content="Delete" cal:Message.Attach="DeleteDefinition" 
                                        Background="#F44336" 
                                        Foreground="White"/>
                            </StackPanel>
                            <DataGrid x:Name="ClassDefinitionsGrid"
                                      ItemsSource="{Binding ClassDefinitions}" 
                                      AutoGenerateColumns="False" 
                                      CanUserAddRows="False" 
                                      Margin="4"
                                      SelectedItem="{Binding SelectedDefinition, Mode=TwoWay}"
                                      RowEditEnding="ClassDefinitionsGrid_RowEditEnding">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ClassKey" Binding="{Binding ClassKey}" IsReadOnly="True" Width="*" />
                                    <DataGridTextColumn Header="DisplayName" Binding="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}" Width="*" />
                                    <DataGridTextColumn Header="Bucket" Binding="{Binding Bucket, UpdateSourceTrigger=PropertyChanged}" Width="100" />
                                    <DataGridTextColumn Header="SortOrder" Binding="{Binding SortOrder, UpdateSourceTrigger=PropertyChanged}" Width="80" />
                                    <DataGridCheckBoxColumn Header="Active" Binding="{Binding IsActive}" Width="60" />
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>
                    </GroupBox>

                    <GroupBox Header="Aliases" Grid.Column="1" Margin="4">
                        <DockPanel>
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="4">
                                <Button Content="Add Alias" cal:Message.Attach="AddAlias" Margin="0,0,4,0" />
                                <Button Content="Save All" cal:Message.Attach="SaveAllAliases" Margin="0,0,4,0" />
                                <Button Content="Delete" cal:Message.Attach="DeleteAlias" 
                                        Background="#F44336" 
                                        Foreground="White"/>
                            </StackPanel>
                            <DataGrid x:Name="ClassAliasesGrid"
                                      ItemsSource="{Binding ClassAliases}" 
                                      AutoGenerateColumns="False" 
                                      CanUserAddRows="False" 
                                      Margin="4"
                                      SelectedItem="{Binding SelectedAlias, Mode=TwoWay}"
                                      RowEditEnding="ClassAliasesGrid_RowEditEnding">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Alias" Binding="{Binding Alias, UpdateSourceTrigger=PropertyChanged}" Width="*" />
                                    <DataGridTextColumn Header="ClassKey" Binding="{Binding ClassKey, UpdateSourceTrigger=PropertyChanged}" Width="*" />
                                </DataGrid.Columns>
                            </DataGrid>
                        </DockPanel>
                    </GroupBox>

                    <GroupBox Header="Unmapped Classes" Grid.Column="2" Margin="4">
                        <StackPanel Margin="4">
                            <TextBlock Text="Select an unmapped class and either create a new definition or map to an existing one." 
                                       TextWrapping="Wrap" 
                                       Margin="0,0,0,8"/>
                            <ListBox ItemsSource="{Binding UnmappedClasses}" 
                                     SelectedItem="{Binding SelectedUnmapped}" 
                                     Height="200" />
                            
                            <!-- New: Create Definition button -->
                            <Border BorderBrush="#2196F3" 
                                    BorderThickness="1" 
                                    Background="#E3F2FD" 
                                    Padding="8" 
                                    Margin="0,8,0,0">
                                <StackPanel>
                                    <TextBlock Text="Quick Create" 
                                               FontWeight="SemiBold" 
                                               Foreground="#1976D2"
                                               Margin="0,0,0,4"/>
                                    <Button Content="Create New Definition" 
                                            cal:Message.Attach="CreateDefinitionFromUnmapped"
                                            HorizontalAlignment="Stretch"
                                            Margin="0,0,0,4"/>
                                    <TextBlock Text="Creates a definition with this name. Edit Bucket and SortOrder in the grid."
                                               TextWrapping="Wrap"
                                               FontSize="10"
                                               Opacity="0.7"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Existing: Map to existing definition -->
                            <Border BorderBrush="#DDD" 
                                    BorderThickness="1" 
                                    Background="#F5F5F5" 
                                    Padding="8" 
                                    Margin="0,8,0,0">
                                <StackPanel>
                                    <TextBlock Text="Or Map to Existing" 
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,4"/>
                                    <TextBlock Text="Map to selected definition:" Margin="0,0,0,4"/>
                                    <ComboBox ItemsSource="{Binding ClassDefinitions}" 
                                              DisplayMemberPath="DisplayName" 
                                              SelectedItem="{Binding SelectedDefinition}" />
                                    <Button Content="Map" 
                                            cal:Message.Attach="MapSelectedUnmappedToSelectedDefinition"
                                            HorizontalAlignment="Stretch"
                                            Margin="0,8,0,0"/>
                                </StackPanel>
                            </Border>
                            
                            <CheckBox Content="Save globally for future events" 
                                      IsChecked="{Binding SaveGlobally}" 
                                      Margin="0,12,0,0" />
                            
                            <StackPanel Orientation="Horizontal" 
                                        HorizontalAlignment="Right" 
                                        Margin="0,8,0,0">
                                <Button Content="Close" cal:Message.Attach="Close"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
